<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KPI Cursor Calculator</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#111720; --muted:#6b7a90; --text:#eaf1ff;
    --accent:#5aa6ff; --ok:#7bd88f; --warn:#facc15; --bad:#ff6b6b;
    --border:#1d2633; --chip:#172131; --hl:#0f1a29;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:#0b0f14; color:var(--text)}
  .wrap{max-width:900px; margin:36px auto; padding:0 16px}
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px}
  h1{font-size:20px; margin:0 0 12px}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  .toggle{display:flex; align-items:center; gap:8px; font-size:14px}
  input[type="checkbox"]{width:18px; height:18px}

  .grid{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
  .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
  @media (max-width:900px){ .col-4,.col-6{grid-column:span 12}}

  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="number"]{
    width:100%; padding:12px; border-radius:10px; border:1px solid var(--border);
    background:#0e1420; color:#eaf1ff; font-size:14px; outline:none;
  }
  .metric{display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px dashed var(--border)}
  .metric:last-child{border-bottom:0}
  .name{font-size:14px}
  .val{font-variant-numeric:tabular-nums; font-weight:700}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .bad{color:var(--bad)}

  /* —Å–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—É–ª—ã/–ø–æ–¥—Å–∫–∞–∑–∫–∏ */
  .advanced{display:none; margin-top:14px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .chip{background:var(--chip); border:1px solid var(--border); color:#cfe1ff; padding:6px 10px; border-radius:999px; font-size:12px}
  .desc{font-size:12px; color:var(--muted)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px dashed var(--border)}
  .row:last-child{border-bottom:0}
  .badge{padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1a29; font-size:12px; color:#cfe1ff; margin-left:6px}
  .eq-hl{background:var(--hl); border:1px solid var(--border); padding:10px 12px; border-radius:10px}
  .right{display:flex; align-items:center; gap:8px}
  .cap{background:#2a79ff22; border:1px solid #2a79ff66; color:#bcd4ff}

  .btns{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
  button{
    background:#1a2535; border:1px solid var(--border); color:#eaf1ff;
    padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px;
  }
  button.primary{background:#2a79ff; border-color:#2a79ff}

  /* –¢–∞–±—ã */
  .tabs{display:flex; gap:8px; margin-bottom:20px; border-bottom:2px solid var(--border); padding-bottom:0}
  .tab{
    background:transparent; border:none; color:var(--muted); padding:12px 20px;
    cursor:pointer; font-size:15px; font-weight:500; border-bottom:2px solid transparent;
    margin-bottom:-2px; transition:all 0.2s;
  }
  .tab:hover{color:var(--text); background:var(--hl)}
  .tab.active{color:var(--accent); border-bottom-color:var(--accent)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>KPI Cursor Calculator</h1>
      <label class="toggle">
        <input id="toggle-advanced" type="checkbox" />
        <span>–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã</span>
      </label>
    </div>

    <!-- –¢–ê–ë–´ –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø -->
    <div class="tabs">
      <button class="tab active" id="tab-dev">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</button>
      <button class="tab" id="tab-pm">–ü—Ä–æ–µ–∫—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</button>
    </div>

    <!-- –§–û–†–ú–ê –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–û–í -->
    <div class="panel" id="dev-panel">
      <!-- –í–≤–æ–¥ -->
      <div class="grid">
        <div class="col-4">
          <label for="t0">T‚ÇÄ ‚Äî ¬´–∫–∞–∫ –±–µ–∑ Cursor¬ª, —á–∞—Å—ã</label>
          <input id="t0"  type="number" step="0.01" min="0" />
        </div>
        <div class="col-4">
          <label for="est">–û—Ü–µ–Ω–∫–∞ —Å Cursor (T·∂ú_est), —á–∞—Å—ã</label>
          <input id="est" type="number" step="0.01" min="0" />
        </div>
        <div class="col-4">
          <label for="act">–§–∞–∫—Ç —Å Cursor (T·∂ú_act), —á–∞—Å—ã</label>
          <input id="act" type="number" step="0.01" min="0.01" />
        </div>
      </div>

      <!-- –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π UI: —Å–ª–µ–≤–∞ ‚Äî –º–µ—Ç—Ä–∏–∫–∏, —Å–ø—Ä–∞–≤–∞ ‚Äî –ø–æ–¥—Å—á—ë—Ç –±–∞–ª–ª–æ–≤ -->
      <div class="grid" style="margin-top:12px">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="col-6">
          <div class="metric"><div class="name">–°—ç–∫–æ–Ω–æ–º–∏–ª–∏ —á–∞—Å–æ–≤</div><div class="val" id="v-save">‚Äî</div></div>
          <div class="metric"><div class="name">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏ (%)</div><div class="val" id="v-acc">‚Äî</div></div>
          <div class="metric"><div class="name">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å (k)</div><div class="val" id="v-k2">‚Äî</div></div>
        </div>
        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –±–∞–ª–ª—ã -->
        <div class="col-6">
          <div class="metric"><div class="name">–ë–∞–ª–ª—ã –∑–∞ —ç–∫–æ–Ω–æ–º–∏—é (Base)</div><div class="val" id="v-base">‚Äî</div></div>
          <div class="metric"><div class="name">–ë–∞–ª–ª—ã –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å (AccuracyBonus)</div><div class="val" id="v-bonus">‚Äî</div></div>
          <div class="metric"><div class="name">–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã</div><div class="val" id="v-total">‚Äî</div></div>
        </div>
      </div>

      <!-- –î–æ–ø-–∏–Ω—Ñ–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º—É–ª—ã –∏ –¥–µ—Ç–∞–ª–∏ -->
      <div class="advanced" id="advanced">
        <div class="chips">
          <span class="chip">Œîsave = max(0, T‚ÇÄ ‚àí T·∂ú_act)</span>
          <span class="chip">Base = 0.1 √ó Œîsave</span>
          <span class="chip">A = max(0, 1 ‚àí |Est ‚àí Act| / Act)</span>
          <span class="chip">V = min(Est, Act)</span>
          <span class="chip">k(A): 0.08 / 0.05 / 0.03 / 0.01 / 0</span>
          <span class="chip">AccuracyBonus = min(k¬∑V, Base)</span>
        </div>

        <div class="grid">
          <div class="col-6">
            <div class="row"><div class="desc">Œîsave = MAX(0; T‚ÇÄ ‚àí T·∂ú_act)</div><div class="val" id="v-save-adv">‚Äî</div></div>
            <div class="row"><div class="desc">Base = 0.1 √ó Œîsave</div><div class="val" id="v-base-adv">‚Äî</div></div>
            <div class="row"><div class="desc">A = MAX(0; 1 ‚àí |Est ‚àí Act| / Act)</div><div class="val" id="v-acc-adv">‚Äî</div></div>
            <div class="row"><div class="desc">V = MIN(T·∂ú_est; T·∂ú_act)</div><div class="val" id="v-vol-adv">‚Äî</div></div>
          </div>
          <div class="col-6">
            <div class="row">
              <div class="desc">k(A) <span class="badge" id="v-k-badge">k = ‚Äî</span></div>
              <div class="val" id="v-k-adv">‚Äî</div>
            </div>
            <div class="row"><div class="desc">–ë–æ–Ω—É—Å —Å—ã—Ä–æ–π = k √ó V</div><div class="val" id="v-bonus-raw-adv">‚Äî</div></div>
            <div class="row"><div class="desc">AccuracyBonus = MIN(–ë–æ–Ω—É—Å —Å—ã—Ä–æ–π; Base)</div><div class="right"><div class="val" id="v-bonus-adv">‚Äî</div><span class="badge cap" id="cap-badge" style="display:none">capped</span></div></div>
            <div class="row eq-hl"><div class="desc"><b>–ò—Ç–æ–≥ = Base + AccuracyBonus</b></div><div class="val" id="v-total-adv">‚Äî</div></div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="preset1">–ü—Ä–∏–º–µ—Ä 1 (40 / 22 / 20)</button>
          <button id="preset2">–ü—Ä–∏–º–µ—Ä 2 (24 / 12 / 18)</button>
          <button id="preset3">–ü—Ä–∏–º–µ—Ä 3 (10 / 6 / 6)</button>
          <button id="reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button id="copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>

    <!-- –§–û–†–ú–ê –î–õ–Ø –ü–†–û–ï–ö–¢–ù–´–• –ú–ï–ù–ï–î–ñ–ï–†–û–í -->
    <div class="panel" id="pm-panel" style="display:none">
      <div style="background:var(--hl); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:16px">
        <div style="font-size:14px; font-weight:600; margin-bottom:6px">KPI: –í—ã—Å—Ç–∞–≤–∏—Ç—å 95% —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ</div>
        <div style="font-size:13px; color:var(--muted); line-height:1.5">
          –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ KPI –Ω–∞ –∫–∞–∂–¥–æ–º –ø—Ä–æ–µ–∫—Ç–µ. –§–æ—Ä–º—É–ª–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—ä–µ–º –ø—Ä–æ–µ–∫—Ç–∞:
          –±–æ–ª—å—à–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–∞—é—Ç –±–æ–ª—å—à–µ –±–∞–ª–ª–æ–≤, –º–∞–ª–µ–Ω—å–∫–∏–µ ‚Äî –º–µ–Ω—å—à–µ.
        </div>
      </div>
      
      <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
      <div style="margin-bottom:16px">
        <label>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</label>
        <div class="grid" style="margin-top:8px">
          <div class="col-12">
            <label for="pm-project-name" style="margin-bottom:4px">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <input id="pm-project-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" style="padding:12px; border-radius:10px; border:1px solid var(--border); background:#0e1420; color:#eaf1ff; font-size:14px; outline:none; width:100%" />
          </div>
          <div class="col-6">
            <label for="pm-project-spent">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ, —á</label>
            <input id="pm-project-spent" type="number" step="0.1" min="0" placeholder="100" />
          </div>
          <div class="col-6">
            <label for="pm-project-billed">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–æ, —á</label>
            <input id="pm-project-billed" type="number" step="0.1" min="0" placeholder="95" />
          </div>
          <div class="col-12">
            <button id="pm-add-project" class="primary" style="width:100%; margin-top:8px">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
          </div>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
      <div id="pm-projects-list" style="margin-bottom:16px">
        <!-- –ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
      </div>

      <!-- –ò—Ç–æ–≥–∏ -->
      <div class="grid">
        <div class="col-6">
          <div class="metric"><div class="name">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div><div class="val" id="pm-total-projects">0</div></div>
          <div class="metric"><div class="name">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</div><div class="val" id="pm-total-hours">0 —á</div></div>
        </div>
        <div class="col-6">
          <div class="metric"><div class="name">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞</div><div class="val" id="pm-avg-hours">‚Äî</div></div>
          <div class="metric"><div class="name"><b>–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã</b></div><div class="val" id="pm-total-points">0.00</div></div>
        </div>
      </div>

      <div class="btns">
        <button id="pm-share-link" class="primary">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞</button>
        <button id="pm-clear-all" style="background:#ff6b6b22; border-color:#ff6b6b66; color:#ff6b6b">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</button>
      </div>

      <!-- –î–µ—Ç–∞–ª–∏ —Ñ–æ—Ä–º—É–ª—ã -->
      <div class="advanced" id="pm-advanced">
        <div style="margin-bottom:16px">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px">–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
          <div class="btns">
            <button id="pm-example-1">–ü—Ä–∏–º–µ—Ä: –ë–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç —Å KPI 98%</button>
            <button id="pm-example-2">–ü—Ä–∏–º–µ—Ä: –ù–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</button>
            <button id="pm-example-3">–ü—Ä–∏–º–µ—Ä: –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç KPI</button>
          </div>
        </div>

        <div style="margin-bottom:16px">
          <div style="font-size:14px; font-weight:600; margin-bottom:12px">–§–æ—Ä–º—É–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤</div>
          <div class="chips">
            <span class="chip">h &lt; 50: –ë–∞–ª–ª—ã = 0.15 √ó ‚àö—á–∞—Å—ã</span>
            <span class="chip">h ‚â• 50: –ë–∞–ª–ª—ã = 0.3 √ó ‚àö—á–∞—Å—ã</span>
            <span class="chip">–ü—Ä–∏ KPI ‚â• 95%</span>
          </div>
          <div style="margin-top:10px; padding:10px 12px; background:var(--chip); border:1px solid var(--border); border-radius:8px; font-size:12px; color:var(--muted)">
            <b>KPI %</b> = (–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ / –ü–æ—Ç—Ä–∞—á–µ–Ω–æ) √ó 100
          </div>
        </div>

        <div style="margin-bottom:16px; padding:14px; background:var(--hl); border-radius:10px; border:1px solid var(--border)">
          <div style="font-size:13px; font-weight:600; margin-bottom:8px; color:var(--accent)">–†–µ—à–∞–µ–º–∞—è –ø—Ä–æ–±–ª–µ–º–∞:</div>
          <div style="font-size:13px; color:var(--muted); line-height:1.6">
            <b>–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞:</b> –ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç = 1 –±–∞–ª–ª –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ–±—ä–µ–º–∞<br/>
            ‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä —Å 1 –ø—Ä–æ–µ–∫—Ç–æ–º –Ω–∞ 1000 —á–∞—Å–æ–≤ ‚Üí 1 –±–∞–ª–ª ‚ùå<br/>
            ‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä —Å 10 –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –ø–æ 5 —á–∞—Å–æ–≤ ‚Üí 10 –±–∞–ª–ª–æ–≤ ‚ùå<br/>
            <br/>
            <b style="color:var(--ok)">–ù–æ–≤–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞:</b> –ë–∞–ª–ª—ã —Ä–∞—Å—Ç—É—Ç —Å –æ–±—ä–µ–º–æ–º, –º–∞–ª—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –¥–∞—é—Ç –º–µ–Ω—å—à–µ<br/>
            ‚Ä¢ –ü—Ä–æ–µ–∫—Ç 10 —á–∞—Å–æ–≤ ‚Üí 0.47 –±–∞–ª–ª–∞ (–º–∞–ª—ã–π –∫–æ—ç—Ñ—Ñ.)<br/>
            ‚Ä¢ –ü—Ä–æ–µ–∫—Ç 100 —á–∞—Å–æ–≤ ‚Üí 3.0 –±–∞–ª–ª–∞ ‚úÖ<br/>
            ‚Ä¢ –ü—Ä–æ–µ–∫—Ç 1000 —á–∞—Å–æ–≤ ‚Üí 9.49 –±–∞–ª–ª–∞ (–≤ 3+ —Ä–∞–∑–∞ –±–æ–ª—å—à–µ!) ‚úÖ<br/>
            ‚Ä¢ 10 –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ 5 —á–∞—Å–æ–≤ ‚Üí 0.34 √ó 10 = 3.4 –±–∞–ª–ª–∞<br/>
            <br/>
            –§–æ—Ä–º—É–ª–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ –Ω–∞–≥—Ä–∞–∂–¥–∞–µ—Ç –∑–∞ –∫—Ä—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –Ω–µ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –º–µ–ª–∫–∏–µ.
          </div>
        </div>

        <div style="padding:14px; background:#2a79ff11; border-radius:10px; border:1px solid #2a79ff33">
          <div style="font-size:13px; font-weight:600; margin-bottom:8px">–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞:</div>
          <div style="font-size:12px; color:var(--muted); line-height:1.8; font-family:monospace">
            <span style="color:var(--warn)">–ú–∞–ª—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (–∫–æ—ç—Ñ—Ñ. 0.15):</span><br/>
            ‚Ä¢ 1 —á–∞—Å    ‚Üí 0.15 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 10 —á–∞—Å–æ–≤  ‚Üí 0.47 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 25 —á–∞—Å–æ–≤  ‚Üí 0.75 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 40 —á–∞—Å–æ–≤  ‚Üí 0.95 –±–∞–ª–ª–∞<br/>
            <br/>
            <span style="color:var(--ok)">–°—Ä–µ–¥–Ω–∏–µ –∏ –∫—Ä—É–ø–Ω—ã–µ (–∫–æ—ç—Ñ—Ñ. 0.3):</span><br/>
            ‚Ä¢ 50 —á–∞—Å–æ–≤  ‚Üí 2.12 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 100 —á–∞—Å–æ–≤ ‚Üí 3.0 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 200 —á–∞—Å–æ–≤ ‚Üí 4.24 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 500 —á–∞—Å–æ–≤ ‚Üí 6.71 –±–∞–ª–ª–∞<br/>
            ‚Ä¢ 1000 —á–∞—Å–æ–≤ ‚Üí 9.49 –±–∞–ª–ª–∞<br/>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
  const $ = (id) => document.getElementById(id);

  function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function round(n, p=2){ return Number.isFinite(n) ? +(Math.round((n + Number.EPSILON) * Math.pow(10,p)) / Math.pow(10,p)) : 0; }
  function kByAccuracy(a){
    if (a >= 0.95) return 0.08;
    if (a >= 0.90) return 0.05;
    if (a >= 0.80) return 0.03;
    if (a >= 0.70) return 0.01;
    return 0.0;
  }
  function accClass(a){
    if (a >= 0.90) return "ok";
    if (a >= 0.70) return "warn";
    return "bad";
  }

  // --- helpers to render blanks
  function setText(id, val){ const el = document.getElementById(id); if (el) el.textContent = val; }
  function clearOutputs(){
    ["v-save","v-base","v-bonus","v-total","v-acc","v-k2",
     "v-save-adv","v-base-adv","v-acc-adv","v-vol-adv","v-k-adv","v-k-badge","v-bonus-raw-adv","v-bonus-adv","v-total-adv"
    ].forEach(id => { const el = document.getElementById(id); if (el){ el.textContent = "‚Äî"; el.className = el.className.replace(/\b(ok|warn|bad)\b/g,"").trim(); }});
    const cap = document.getElementById("cap-badge"); if (cap) cap.style.display = "none";
  }

  // ---- Read query params (empty means empty inputs)
  function readQueryParams() {
    const q = new URLSearchParams(window.location.search);
    const getOr = (a,b) => q.has(a) ? q.get(a) : (q.has(b) ? q.get(b) : null);

    const t0  = getOr("t0","t1");
    const est = getOr("est","t2");
    const act = getOr("act","t3");

    if (t0  !== null)  document.getElementById("t0").value  = t0;
    if (est !== null)  document.getElementById("est").value = est;
    if (act !== null)  document.getElementById("act").value = act;

    const show = q.get("show");
    if (show === "1" || show === "true") {
        const cb = document.getElementById("toggle-advanced");
        const adv = document.getElementById("advanced");
        if (cb) cb.checked = true;
        if (adv) adv.style.display = "block";
    }
  }

  // ---- Write query params (only non-empty values)
  function writeQueryParams() {
    const q = new URLSearchParams();

    const t0  = document.getElementById("t0").value?.trim()  || "";
    const est = document.getElementById("est").value?.trim() || "";
    const act = document.getElementById("act").value?.trim() || "";

    if (t0)  q.set("t0",  t0);
    if (est) q.set("est", est);
    if (act) q.set("act", act);

    const advOn = document.getElementById("toggle-advanced")?.checked;
    if (advOn) q.set("show","1");

    const query = q.toString();
    const hash  = window.location.hash || "";
    const newUrl = query ? `${location.pathname}?${query}${hash}`
                        : `${location.pathname}${hash}`;
    history.replaceState(null, "", newUrl);
  }

  function canCalc(){
    // –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º–∏
    return $("t0").value !== "" && $("est").value !== "" && $("act").value !== "";
  }

  function recalc(){
    // URL –¥–µ—Ä–∂–∏–º –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–µ –≤—Å–µ–≥–¥–∞
    writeQueryParams();

    if (!canCalc()){
      clearOutputs();
      return;
    }

    const t0 = Math.max(0, toNum($("t0").value));
    const est = Math.max(0, toNum($("est").value));
    const actRaw = Number($("act").value);
    if (!Number.isFinite(actRaw) || actRaw <= 0){
      clearOutputs(); // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0 –∏ –Ω–µ—á–∏—Å–µ–ª
      return;
    }
    const act = actRaw;

    const save = Math.max(0, t0 - act);
    const base = 0.1 * save;

    const acc = Math.max(0, 1 - Math.abs(est - act) / act);
    const V = Math.min(est, act);
    const k = kByAccuracy(acc);
    const bonusRaw = k * V;
    const bonus = Math.min(bonusRaw, base);
    const total = base + bonus;

    // –õ—ë–≥–∫–∏–π UI
    setText("v-save",  round(save,2) + " —á");

    const accPctText = (round(acc,4)*100).toFixed(2) + " %";
    const aClass = accClass(acc);
    const accEl = $("v-acc"); accEl.textContent = accPctText; accEl.className = "val " + aClass;

    setText("v-k2",    k.toFixed(2));
    setText("v-base",  round(base,2).toFixed(2));
    setText("v-bonus", round(bonus,2).toFixed(2));
    setText("v-total", round(total,2).toFixed(2));

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
    setText("v-save-adv",  round(save,2) + " —á");
    setText("v-base-adv",  round(base,2).toFixed(2));
    const accAdv = $("v-acc-adv"); if (accAdv){ accAdv.textContent = accPctText; accAdv.className = "val " + aClass; }
    setText("v-vol-adv",   round(V,2) + " —á");
    setText("v-k-adv",     k.toFixed(2));
    const kBadge = $("v-k-badge"); if (kBadge) kBadge.textContent = "k = " + k.toFixed(2);
    setText("v-bonus-raw-adv", round(bonusRaw,2).toFixed(2));
    setText("v-bonus-adv",     round(bonus,2).toFixed(2));
    setText("v-total-adv",     round(total,2).toFixed(2));

    const cap = $("cap-badge");
    if (cap) cap.style.display = (bonus > 0 && Math.abs(bonus - base) < 1e-9) ? "inline-block" : "none";
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ñ–æ—Ä–º—É–ª
  const toggle = document.getElementById("toggle-advanced");
  if (toggle) {
    toggle.addEventListener("change", (e)=>{
      const adv = document.getElementById("advanced");
      if (adv) adv.style.display = e.target.checked ? "block" : "none";
      writeQueryParams(); // –æ–±–Ω–æ–≤–∏–º ?show=1|‚Äî –≤ URL
    });
  }

  // –ü—Ä–µ—Å–µ—Ç—ã/–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  function bindButtons(){
    const p1 = document.getElementById("preset1");
    const p2 = document.getElementById("preset2");
    const p3 = document.getElementById("preset3");
    const reset = document.getElementById("reset");
    const copy = document.getElementById("copy");

    if (p1) p1.addEventListener("click", ()=>{ $("t0").value=40; $("est").value=22; $("act").value=20; recalc(); });
    if (p2) p2.addEventListener("click", ()=>{ $("t0").value=24; $("est").value=12; $("act").value=18; recalc(); });
    if (p3) p3.addEventListener("click", ()=>{ $("t0").value=10; $("est").value=6; $("act").value=6; recalc(); });
    if (reset) reset.addEventListener("click", ()=>{ $("t0").value=""; $("est").value=""; $("act").value=""; recalc(); });
    if (copy)  copy.addEventListener("click", async ()=>{
      const text = [
        `Link: ${location.href}`,
        `T0: ${$("t0").value||""}`, `Est: ${$("est").value||""}`, `Act: ${$("act").value||""}`,
        `Œîsave: ${document.getElementById("v-save").textContent}`,
        `Base: ${document.getElementById("v-base").textContent}`,
        `Accuracy: ${document.getElementById("v-acc").textContent}`,
        `k: ${document.getElementById("v-k2").textContent}`,
        `AccuracyBonus: ${document.getElementById("v-bonus").textContent}`,
        `Total: ${document.getElementById("v-total").textContent}`
      ].join("\n");
      try{ await navigator.clipboard.writeText(text); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì"); }
      catch(e){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: " + e); }
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  readQueryParams();
  bindButtons();

  // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∏–Ω–ø—É—Ç—ã
  ["t0","est","act"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", recalc);
      el.addEventListener("change", recalc);
    }
  });

  // –ü–µ—Ä–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç (–Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—à–µ—Ç –≤ URL, –µ—Å–ª–∏ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ)
  recalc();

  // ========================================
  // –§–£–ù–ö–¶–ò–û–ù–ê–õ –î–õ–Ø –ü–†–û–ï–ö–¢–ù–´–• –ú–ï–ù–ï–î–ñ–ï–†–û–í
  // ========================================

  let pmProjects = [];

  // –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å –ø–æ–Ω–∏–∂–µ–Ω–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏ –¥–ª—è –º–∞–ª—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
  function calculateProjectPoints(spent, billed) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ KPI 95%
    const kpiPercent = (billed / spent) * 100;
    if (kpiPercent < 95) {
      return 0; // KPI –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
    }
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏:
    // –î–ª—è –º–∞–ª—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (< 50—á): –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    // –î–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (>= 50—á): –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    let points;
    if (spent < 50) {
      // –ú–∞–ª—ã–µ –ø—Ä–æ–µ–∫—Ç—ã: 0.15 * sqrt(—á–∞—Å—ã)
      points = 0.15 * Math.sqrt(spent);
    } else {
      // –°—Ä–µ–¥–Ω–∏–µ –∏ –∫—Ä—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã: 0.3 * sqrt(—á–∞—Å—ã)
      points = 0.3 * Math.sqrt(spent);
    }
    
    return points;
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç KPI
  function getProjectColor(kpiPercent) {
    if (kpiPercent >= 95) return "ok";
    if (kpiPercent >= 90) return "warn";
    return "bad";
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
  function getProjectSize(hours) {
    if (hours >= 500) return { badge: "background:#7bd88f22; border-color:#7bd88f66; color:#7bd88f", text: "–û–≥—Ä–æ–º–Ω—ã–π" };
    if (hours >= 200) return { badge: "background:#7bd88f22; border-color:#7bd88f66; color:#7bd88f", text: "–ö—Ä—É–ø–Ω—ã–π" };
    if (hours >= 100) return { badge: "background:#7bd88f22; border-color:#7bd88f66; color:#7bd88f", text: "–ë–æ–ª—å—à–æ–π" };
    if (hours >= 50) return { badge: "background:#facc1522; border-color:#facc1566; color:#facc15", text: "–°—Ä–µ–¥–Ω–∏–π" };
    if (hours >= 20) return { badge: "background:#facc1522; border-color:#facc1566; color:#facc15", text: "–ú–∞–ª—ã–π" };
    return { badge: "background:var(--chip); border-color:var(--border); color:var(--muted)", text: "–ú–∏–Ω–∏" };
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
  function renderPMProjects() {
    const list = document.getElementById("pm-projects-list");
    if (!list) return;

    if (pmProjects.length === 0) {
      list.innerHTML = '<div class="desc" style="text-align:center; padding:20px; color:var(--muted)">–ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
      updatePMStats();
      return;
    }

    list.innerHTML = pmProjects.map((project, idx) => {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
      if (!project || project.spent === undefined || project.billed === undefined) {
        return ''; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –ø—Ä–æ–µ–∫—Ç
      }
      
      const kpiPercent = (project.billed / project.spent) * 100;
      const points = calculateProjectPoints(project.spent, project.billed);
      const colorClass = getProjectColor(kpiPercent);
      const size = getProjectSize(project.spent);
      
      const kpiAchieved = kpiPercent >= 95;
      const kpiIcon = kpiAchieved ? '‚úÖ' : '‚ùå';
      
      const warningBadge = !kpiAchieved ? `
        <div style="margin-top:8px; padding:8px 10px; background:#ff6b6b11; border:1px solid #ff6b6b33; border-radius:8px; font-size:12px; color:#ff6b6b">
          ‚ö†Ô∏è KPI –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è ‚â•95%). –ë–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è.
        </div>
      ` : '';
      
      return `
        <div style="background:var(--hl); border:1px solid ${kpiAchieved ? 'var(--border)' : '#ff6b6b33'}; border-radius:10px; padding:14px; margin-bottom:8px">
          <div style="display:flex; justify-content:space-between; align-items:start; gap:12px">
            <div style="flex:1">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
                <div style="font-size:14px; font-weight:600">${project.name}</div>
                <span class="badge" style="${size.badge}">${size.text}</span>
              </div>
              <div style="font-size:12px; color:var(--muted); margin-bottom:4px">
                <span>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${project.spent.toFixed(1)} —á</span>
                <span style="margin:0 8px">‚Ä¢</span>
                <span>–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ: ${project.billed.toFixed(1)} —á</span>
              </div>
              <div style="font-size:13px; display:flex; align-items:center; gap:12px; flex-wrap:wrap">
                <span class="${colorClass}" style="font-weight:600">${kpiIcon} KPI: ${kpiPercent.toFixed(1)}%</span>
                <span style="color:var(--border)">‚Ä¢</span>
                <span class="${points > 0 ? 'ok' : 'bad'}" style="font-weight:600">
                  ‚≠ê ${points.toFixed(2)} ${points === 1 ? '–±–∞–ª–ª' : points < 5 ? '–±–∞–ª–ª–∞' : '–±–∞–ª–ª–æ–≤'}
                </span>
              </div>
              ${warningBadge}
            </div>
            <button onclick="removePMProject(${idx})" style="background:#ff6b6b22; border:1px solid #ff6b6b66; color:#ff6b6b; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:12px; white-space:nowrap">
              –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      `;
    }).join('');

    updatePMStats();
    savePMToURL();
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  function updatePMStats() {
    // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
    const validProjects = pmProjects.filter(p => p && p.spent !== undefined && p.billed !== undefined);
    
    const totalProjects = validProjects.length;
    const totalSpent = validProjects.reduce((sum, p) => sum + (p.spent || 0), 0);
    const totalPoints = validProjects.reduce((sum, p) => sum + calculateProjectPoints(p.spent, p.billed), 0);
    const avgHours = totalProjects > 0 ? totalSpent / totalProjects : 0;

    setText("pm-total-projects", totalProjects);
    setText("pm-total-hours", totalSpent.toFixed(1) + " —á");
    setText("pm-avg-hours", totalProjects > 0 ? avgHours.toFixed(1) + " —á" : "‚Äî");
    setText("pm-total-points", totalPoints.toFixed(2));

    // –ï—Å–ª–∏ –±—ã–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤
    if (validProjects.length !== pmProjects.length) {
      pmProjects = validProjects;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    savePMProjects();
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
  function addPMProject() {
    const nameInput = document.getElementById("pm-project-name");
    const spentInput = document.getElementById("pm-project-spent");
    const billedInput = document.getElementById("pm-project-billed");
    
    const name = nameInput ? nameInput.value.trim() : "";
    const spent = spentInput ? parseFloat(spentInput.value) : NaN;
    const billed = billedInput ? parseFloat(billedInput.value) : NaN;

    if (!name) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞");
      return;
    }

    if (!Number.isFinite(spent) || spent <= 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö —á–∞—Å–æ–≤");
      return;
    }

    if (!Number.isFinite(billed) || billed < 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —á–∞—Å–æ–≤");
      return;
    }

    if (billed > spent) {
      if (!confirm(`–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ (${billed}—á) –±–æ–ª—å—à–µ —á–µ–º –ø–æ—Ç—Ä–∞—á–µ–Ω–æ (${spent}—á). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
        return;
      }
    }

    pmProjects.push({ name, spent, billed });
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    if (nameInput) nameInput.value = "";
    if (spentInput) spentInput.value = "";
    if (billedInput) billedInput.value = "";
    
    renderPMProjects();
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
  window.removePMProject = function(idx) {
    pmProjects.splice(idx, 1);
    renderPMProjects();
  };

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
  function savePMProjects() {
    try {
      localStorage.setItem('pm-projects', JSON.stringify(pmProjects));
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã:", e);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  function loadPMProjects() {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ —É–∂–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
      if (pmProjects.length > 0) {
        return;
      }
      
      const saved = localStorage.getItem('pm-projects');
      if (saved) {
        const parsed = JSON.parse(saved);
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è: –µ—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö –µ—Å—Ç—å —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ 'hours', –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        pmProjects = parsed.map(project => {
          if (project.hours !== undefined && project.spent === undefined) {
            // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
            return {
              name: project.name,
              spent: project.hours,
              billed: project.hours * 0.95 // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 95% KPI
            };
          }
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
          if (project.spent !== undefined && project.billed !== undefined) {
            return project;
          }
          return null;
        }).filter(p => p !== null);
        
        renderPMProjects();
      }
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã:", e);
      // –û—á–∏—â–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      localStorage.removeItem('pm-projects');
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ URL (–¥–ª—è —à–∞—Ä–∏–Ω–≥–∞) - –∏—Å–ø–æ–ª—å–∑—É–µ–º hash –≤–º–µ—Å—Ç–æ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  function savePMToURL() {
    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–µ–∫—Ç—ã –≤ hash (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å file://)
      if (pmProjects.length > 0) {
        const jsonStr = JSON.stringify(pmProjects);
        const encoded = encodeURIComponent(jsonStr);
        const newHash = `#pm=${encoded}`;
        
        // –î–ª—è file:// –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º hash
        const search = window.location.search || "";
        const newUrl = `${location.pathname}${search}${newHash}`;
        
        history.replaceState(null, "", newUrl);
      }
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ URL:", e);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ URL —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ hash –∏ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  function loadPMFromURL() {
    try {
      let pmData = null;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ hash (–¥–ª—è file://)
      if (window.location.hash) {
        const hashMatch = window.location.hash.match(/[#&]pm=([^&]*)/);
        if (hashMatch && hashMatch[1]) {
          pmData = decodeURIComponent(hashMatch[1]);
        }
      }
      
      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ hash, –ø—Ä–æ–±—É–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–¥–ª—è http://)
      if (!pmData && window.location.search) {
        const q = new URLSearchParams(window.location.search);
        pmData = q.get('pm');
      }
      
      if (pmData) {
        const projects = JSON.parse(pmData);
        
        if (Array.isArray(projects) && projects.length > 0) {
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL
          pmProjects = projects.map(project => {
            if (project.hours !== undefined && project.spent === undefined) {
              // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
              return {
                name: project.name,
                spent: project.hours,
                billed: project.hours * 0.95
              };
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
            if (project.spent !== undefined && project.billed !== undefined && project.name) {
              return project;
            }
            return null;
          }).filter(p => p !== null);
          
          if (pmProjects.length > 0) {
            renderPMProjects();
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç–∞–± –†–ú –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            switchTab("pm");
            return true;
          }
        }
      }
      return false;
    } catch (e) {
      console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ URL:", e);
      return false;
    }
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏ —á–µ—Ä–µ–∑ —Ç–∞–±—ã
  const tabDev = document.getElementById("tab-dev");
  const tabPM = document.getElementById("tab-pm");
  const devPanel = document.getElementById("dev-panel");
  const pmPanel = document.getElementById("pm-panel");

  function switchTab(activeTab) {
    if (activeTab === "dev") {
      if (tabDev) tabDev.classList.add("active");
      if (tabPM) tabPM.classList.remove("active");
      if (devPanel) devPanel.style.display = "block";
      if (pmPanel) pmPanel.style.display = "none";
    } else if (activeTab === "pm") {
      if (tabDev) tabDev.classList.remove("active");
      if (tabPM) tabPM.classList.add("active");
      if (devPanel) devPanel.style.display = "none";
      if (pmPanel) pmPanel.style.display = "block";
    }
  }

  if (tabDev) {
    tabDev.addEventListener("click", () => switchTab("dev"));
  }
  if (tabPM) {
    tabPM.addEventListener("click", () => switchTab("pm"));
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–µ–∏—Ö —Ñ–æ—Ä–º)
  // –£–∂–µ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è dev-panel –≤—ã—à–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è PM
  if (toggle) {
    // –†–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    const originalChange = toggle.onchange;
    toggle.addEventListener("change", (e) => {
      const pmAdv = document.getElementById("pm-advanced");
      if (pmAdv) {
        pmAdv.style.display = e.target.checked ? "block" : "none";
      }
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  const addProjectBtn = document.getElementById("pm-add-project");
  if (addProjectBtn) {
    addProjectBtn.addEventListener("click", (e) => {
      e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ —ç—Ç–æ —Å–ª—É—á–∞–π–Ω–æ —Ñ–æ—Ä–º–∞
      addPMProject();
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —à–∞—Ä–∏–Ω–≥–∞
  const shareLinkBtn = document.getElementById("pm-share-link");
  if (shareLinkBtn) {
    shareLinkBtn.addEventListener("click", async () => {
      if (pmProjects.length === 0) {
        alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç");
        return;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º URL –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      savePMToURL();
      
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ URL –æ–±–Ω–æ–≤–∏–ª—Å—è
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const url = window.location.href;
      
      try {
        await navigator.clipboard.writeText(url);
        const btn = shareLinkBtn;
        const originalText = btn.textContent;
        btn.textContent = "‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!";
        btn.style.background = "#7bd88f";
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = "";
        }, 2000);
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:", e);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ alert –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:", url);
      }
    });
  }


  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
  const clearAllBtn = document.getElementById("pm-clear-all");
  if (clearAllBtn) {
    clearAllBtn.addEventListener("click", () => {
      if (pmProjects.length === 0) return;
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã (${pmProjects.length})? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        pmProjects = [];
        renderPMProjects();
      }
    });
  }

  // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  const pmProjectName = document.getElementById("pm-project-name");
  const pmProjectSpent = document.getElementById("pm-project-spent");
  const pmProjectBilled = document.getElementById("pm-project-billed");
  [pmProjectName, pmProjectSpent, pmProjectBilled].forEach(input => {
    if (input) {
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addPMProject();
        }
      });
    }
  });

  // –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const pmExample1 = document.getElementById("pm-example-1");
  const pmExample2 = document.getElementById("pm-example-2");
  const pmExample3 = document.getElementById("pm-example-3");

  if (pmExample1) {
    pmExample1.addEventListener("click", () => {
      pmProjects = [
        { name: "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª", spent: 1000, billed: 980 }
      ];
      renderPMProjects();
      if (toggle && toggle.checked === false) {
        toggle.click(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã
      }
    });
  }

  if (pmExample2) {
    pmExample2.addEventListener("click", () => {
      pmProjects = [
        { name: "–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", spent: 150, billed: 145 },
        { name: "CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è", spent: 80, billed: 78 },
        { name: "–†–µ–¥–∏–∑–∞–π–Ω –ª–µ–Ω–¥–∏–Ω–≥–∞", spent: 45, billed: 44 },
        { name: "API –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤", spent: 25, billed: 24 },
        { name: "–ë–∞–≥-—Ñ–∏–∫—Å—ã", spent: 5, billed: 5 }
      ];
      renderPMProjects();
      if (toggle && toggle.checked === false) {
        toggle.click(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã
      }
    });
  }

  if (pmExample3) {
    pmExample3.addEventListener("click", () => {
      pmProjects = [
        { name: "–ü—Ä–æ–µ–∫—Ç A (KPI 98%)", spent: 100, billed: 98 },
        { name: "–ü—Ä–æ–µ–∫—Ç B (KPI 92% - –Ω–µ—Ç –±–∞–ª–ª–æ–≤)", spent: 50, billed: 46 },
        { name: "–ü—Ä–æ–µ–∫—Ç C (KPI 96%)", spent: 30, billed: 29 }
      ];
      renderPMProjects();
      if (toggle && toggle.checked === false) {
        toggle.click(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã
      }
    });
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ URL, –ø–æ—Ç–æ–º –∏–∑ localStorage
  const loadedFromURL = loadPMFromURL();
  if (!loadedFromURL && pmProjects.length === 0) {
    loadPMProjects();
  }
</script>
</body>
</html>
